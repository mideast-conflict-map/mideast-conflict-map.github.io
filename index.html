<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Interactive Iran Map</title>

  <!-- Leaflet -->
  <link rel="stylesheet"
        href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    /* ---------- overall look ---------- */
    :root{ --bg:#111; --panel:#1b1b1b; --text:#e5e5e5; }
    html,body{height:100%;margin:0;background:var(--bg);
              color:var(--text);font-family:system-ui,sans-serif;}
    #map{height:100%;width:100%;}

    /* hide default overlay labels – we rebuild them */
    .leaflet-control-layers-overlays label{display:none;}

    /* ---------- custom layer panel ---------- */
    .customLayers{
      background:var(--panel)!important;color:var(--text);
      padding:.5rem .75rem .7rem;border-radius:12px;
      box-shadow:0 0 10px #0009;font-size:.86rem;
      direction:rtl;line-height:1.6;overflow:auto;max-height:80vh;
    }
    .customLayers .updateStamp{
      font-weight:600;margin-bottom:.4rem;white-space:nowrap;
    }
    .customLayers .row{
      display:flex;align-items:center;gap:.55rem;margin:.15rem 0;
      white-space:nowrap;
    }
    .customLayers img{width:20px;height:20px;filter:drop-shadow(0 0 2px #0007);}

    /* ---------- toggle switch ---------- */
    .customLayers input[type="checkbox"]{
      appearance:none;width:34px;height:18px;border-radius:9px;
      background:#555;cursor:pointer;outline:none;position:relative;
      transition:background .2s;flex-shrink:0;
    }
    .customLayers input[type="checkbox"]::after{
      content:"";position:absolute;top:2px;left:2px;width:14px;height:14px;
      background:#fff;border-radius:50%;transition:left .2s;
    }
    .customLayers input[type="checkbox"]:checked{
      background:#2ecc71;
    }
    .customLayers input[type="checkbox"]:checked::after{left:18px;}
  </style>
</head>
<body>
  <div id="map"></div>

  <script>
  /*******************************************************************
   * 1.  DEFINE THE LAYERS – Persian labels only in UI                *
   *******************************************************************/
  const GROUPS = [
    { label:'حملات هوایی اسرائیل – خرداد ۱۴۰۴', file:'by_group/IDF_Strikes_June_2025.geojson',   icon:'icons/large/strike.png',  color:'#e74c3c' },
    { label:'هشدار تخلیه ارتش اسرائیل',        file:'by_group/IDF_Evacuation_Areas.geojson',    icon:'icons/evac.svg',          color:'#f1c40f' },
    { label:'سایت‌های هسته‌ای',               file:'by_group/Nuclear_Sites.geojson',           icon:'icons/large/nuclear.png', color:'#9b59b6' },
    { label:'پایگاه‌های موشکی',                file:'by_group/Missile_Bases.geojson',           icon:'icons/large/missile.png', color:'#d35400' },
    { label:'پایگاه‌های هوایی',                      file:'by_group/Airfields.geojson',               icon:'icons/large/airfield.png',color:'#2980b9' },
    { label:'پایگاه‌های دریایی',               file:'by_group/Naval_Bases.geojson',             icon:'icons/large/naval.png',   color:'#16a085' },
    { label:'زیرساخت ملی',                     file:'by_group/National_Infrastructure.geojson', icon:'icons/large/power.png',   color:'#2ecc71' },
    { label:'پایگاه‌های نظامی و سپاه',          file:'by_group/Military_&_IRGC_Bases.geojson',   icon:'icons/large/irgc.png',    color:'#c0392b' },
    { label:'منطقه برتری هوایی اسرائیل',        file:'by_group/IAF_ASZ.geojson',                 icon:'icons/asz.svg',           color:'#3498db' },
    { label:'منطقه برتری هوایی توسعه‌یافته',    file:'by_group/IAF_ASZ_Expanded.geojson',        icon:'icons/asz_ex.svg',        color:'#5555ff' },
    { label:'عملیات زمینی اسرائیل',             file:'by_group/Israeli_Operations_2024.geojson', icon:'icons/large/israeli.png', color:'#27ae60' }
  ];

  /*******************************************************************
   * 2.  INIT MAP                                                     *
   *******************************************************************/
  const map = L.map('map',{
    zoomSnap:1,zoomDelta:1,minZoom:3,wheelPxPerZoomLevel:40
  }).setView([33.5,48],6);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
    attribution:'&copy; OpenStreetMap contributors'
  }).addTo(map);

  const overlayLayers = {};
  const fetches = GROUPS.map(meta =>
    fetch(meta.file).then(r=>r.json()).then(data=>{
      const layer=L.geoJSON(data,{
        style:{color:meta.color,weight:2,fillOpacity:0.25},
        pointToLayer:(_f,latlng)=>L.marker(latlng,{
          icon:L.icon({iconUrl:meta.icon,iconSize:[18,18]})
        })
      }).addTo(map);
      overlayLayers[meta.label]=layer;   // Persian key
    }).catch(e=>console.warn('⚠️',meta.file,e))
  );

  /*******************************************************************
   * 3.  AFTER ALL LAYERS ARE LOADED…                                 *
   *******************************************************************/
  Promise.allSettled(fetches).then(()=>{
    /* a)  build the switch panel */
    const ctrl=L.control.layers(null,overlayLayers,{collapsed:false}).addTo(map);
    const box=ctrl.getContainer();
    box.classList.add('customLayers');

    /* b)  add “last update” stamp (Persian text) */
    const stamp=document.createElement('div');
    stamp.className='updateStamp';
    stamp.textContent='آخرین بروزرسانی: '+
      new Date().toLocaleDateString('fa-IR',{year:'numeric',month:'short',day:'2-digit'});
    box.prepend(stamp);

    /* c)  re-build each label row: icon + Persian label + toggle */
    [...box.querySelectorAll('label')].forEach(label=>{
      const span=label.querySelector('span');
      const cb  =label.querySelector('input[type="checkbox"]');
      if(!span||!cb)return;
      const meta=GROUPS.find(g=>g.label===span.textContent);
      if(!meta)return;

      span.remove();                   // remove default text
      label.className='row';           // flex container
      const img=document.createElement('img');
      img.src=meta.icon;
      const txt=document.createElement('span');
      txt.textContent=meta.label;

      label.prepend(txt);
      label.prepend(img);
      label.append(cb);                // toggle on left (RTL)
      cb.checked=true;
    });

    /* d)  fit the map to all layers */
    const all=L.featureGroup(Object.values(overlayLayers));
    if(all.getLayers().length && all.getBounds().isValid()){
      map.fitBounds(all.getBounds(),{padding:[20,20]});
    }
  });
  </script>
</body>
</html>
